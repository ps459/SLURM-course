\documentclass[handout]{beamer} %No presenter effects
%\documentclass{beamer} %Presenter effects
\usepackage{pgfpages}
\pgfpagesuselayout{4 on 1}[a4paper,border shrink=5mm,landscape] %4 sided handout

\mode<presentation>
{
  \usetheme{cambridge}
  \setbeamertemplate{navigation symbols}{}
  \setbeamercovered{transparent}
}

\usepackage[english]{babel}
\usepackage[latin1]{inputenc}
\usepackage{multicol}

\title[An introduction to HPC on CSD3] % (optional, use only with long paper titles)
{An Introduction to High Performance Computing: Exercises}

\author[SJ Rankin & P Sumption] % (optional, use only with lots of authors)
{Paul Sumption\\ \texttt{support@hpc.cam.ac.uk}}

\institute[UIS, University of Cambridge]
{Research Computing Services (http://www.hpc.cam.ac.uk/)\\
University Information Services (http://www.uis.cam.ac.uk/)}

\date[22/05/2018] % (optional)
{22nd May 2018 / CSD3 User Training}

\subject{Courses}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\section{Exercises}
\subsection{Exercise 1: Login with SSH}
\begin{frame}{Exercise 1: Login}
Using a Linux terminal you will login to the cluster with your HPC training account.
\begin{itemize}
\item{Start the terminal by double clicking on the terminal icon}
\item In your terminal enter:
\item{ssh -Y \textbf{abc123}@login-cpu.hpc.cam.ac.uk}\\
Replace abc123 with your training account username 
\item {Enter your password as supplied on the sheet}
\item{Leave this terminal open, you will need it for exercise 3!}
\end{itemize}
\end{frame}

\subsection{Exercise 2: SFTP file transfer - pt1}
\begin{frame}{Exercise 2: Transfer some files}
You will need to transfer the exercise files to the cluster.
\begin{itemize}
\item{Open a second Linux terminal on your training computer.}
\item{Enter this command: cd \alert{\footnotesize \path{~\Course_material}}}
\item{Check the file 'exercises.tar is in your directory listing}
\item{Hint: ls}
\end{itemize}
\end{frame}

\subsection{Exercise 2: SFTP file transfer - pt2}
\begin{frame}{Exercise 3: Transfer some files}
Transfer the exercises.tar to your HPC home folder.
\begin{itemize}
\item{In the local terminal on your training computer enter the command:}
\item \alert{\footnotesize sftp abc123@login.hpc.cam.ac.uk}\\
Change abc123 to your training account username
\item{The command: \alert{\footnotesize put exercises.tar} will transfer the file from your local computer to the remote one}
\item Type 'exit' to close the local terminal
\end{itemize}
\end{frame}

\subsection{Excercise 3: Learn more about a command}
\begin{frame}{Exercise 3: Learn more about a command}
\begin{itemize}
\item[(a)]{View the man page for the \alert{cp} command by doing \alert{man cp}. Use \alert{SPACE} to page down and \alert{b} to page up. Press \alert{q} to exit the manual page command.}

\item[(b)]{Copy \alert{exercises.tar} to the $\tilde{}$/hpc-work directory. Note that $\tilde{}$ is just a convenient shorthand for your home directory. Omitting the $\tilde{}$/ will look for a hpc-work in the current directory.}
\visible<2->{\begin{description}
\item[\emph{Hints:}]{Do \alert{cp exercises.tar\quad$\tilde{}$/hpc-work/}. Note that you can often reduce typing by pressing \alert{TAB}.}
\end{description}}
\end{itemize}
 \end{frame}

\subsection{Excercise 4: Unzip the excercises.tar file}
\begin{frame}{Exercise 4: Unzip the excercises.tar file}
  \begin{itemize}

\item[(a)]{Use the \alert{cd} command to enter the $\tilde{}$/hpc-work directory and then list the contents --- you should see the copy of exercises.tgz.}
 \visible<3->{\begin{description}
\item[\emph{Hints:}]{Do \alert{cd\quad$\tilde{}$/hpc-work/} then \alert{ls -al}. Note that \alert{cd ..} will take you back up one step to the home directory.}
\end{description}}

\item[(b)]{Unpack the tar archive to create an exercise subdirectory.}
\visible<4->{\begin{description}
\item[\emph{Hints:}]{Do \alert{tar -zxvf exercises.tar}}
\end{description}}
\end{itemize}
\end{frame}


\subsection{Excercise 5: Navigating the command line}
\begin{frame}{Exercise 5: File listings}
\begin{itemize}

\item[(a)]{In a terminal logged into the cluster list the contents of your current directory \alert{ls}. This won't show everything --- use \alert{ls -al} for a long listing showing all files. Initially you will start in your home directory --- use \alert{pwd} to print the name of your current working directory. If you get lost, you can always do \alert{cd} without arguments to return to your home directory.}

\item[(b)]{Focus your long listing on \alert{all files with names beginning ``exercise''}.}
 \visible<2->{\begin{description}
\item[\emph{Hints:}]{Do \alert{ls -al exercise*}}
\end{description}}

\item[(c)]{Print a long listing of the subdirectory \alert{hpc-work}.}
 \visible<3->{\begin{description}
\item[\emph{Hints:}]{Do \alert{ls -al hpc-work/}. Note that omitting the / reveals that the item hpc-work is actually a shortcut (technically a symbolic link) to \alert{/hpc-work/username}.}
 \end{description}}

\end{itemize}
\end{frame}

\subsection{Modules: Excercise 6}
\begin{frame}[fragile]{Excercise 6: Environment Modules}
\begin{itemize}
\item{Connect to the cluster using your training account: See excercise 1 if you have closed your terminal. }
\item{Get a list of modules that are currently loaded}
\item[\emph{Hints:}]{\alert{module list}}
\item{Get a list of available R modules}
\item[\emph{Hints:}]{\alert{module av R}}
\end{itemize}
\end{frame}

\subsection{Modules: Excercise 7}
\begin{frame}[fragile]{Excercise 7: Run an Rscript}
\begin{itemize}
\item{Connect to the cluster using your training account: See excercise 1 if you have closed your terminal.}
\item{In the exercises folder you transferred earlier there is a file called test.r}
\item{Run this script using: Rscript hello.r }
\item{Load the module for: R/3.3.2}
\item[\emph{Hints:}]{\alert{module load R/3.3.2}}
\item{Run the script again: Rscript hello.r}
\item{What happens? what changes?}
\end{itemize}
\end{frame}

\subsection{Local R library: Excercise 8}
\begin{frame}[fragile]{Exercise 8: Install the R library locally}
As a user you can create a local R library directory for packages that you want to install. 
\begin{itemize}
\item Load an R module: 
module load r-3.4.3-gcc-5.4.0-rbvhnga
\item Create a folder in your home for your own R package installs:
mkdir ~/my-R-libs
\item Make R aware of the new library location:
\begin{verbatim}
echo "R_LIBS_USER=~/my-R-libs" \textgreater .Renviron
\end{verbatim}
\item Start R:
R
\item Display your library paths:
.libPaths()
\item Try loading a library:
require(pander)
\item Its not insalled, lets install it:
install.packages("pander")
\item Try loading a library:
require(pander)
\item Library is now installed, lets quit R:
quit()
\end{itemize}
\end{frame}

\subsection{Excercise 8: notes}
\begin{frame}[fragile]{Excercise 8: Explained}
\begin{itemize}
\item Our R modules: module load r/(version). We have two sets of R modules, those with an upper case R where compiled for an older version of Linux and should be ignored (Darwin legacy)
\item echo " " outputs the text between the quotes, \textgreater redirects the text into the .Renviron file.
\item When we start R the .Renviron file is read and R will now be aware of our local library directory.
\item .libPaths() is how to check your library locations 
\end{itemize}
\end{frame}

\subsection{Excercise 9: Modules and Compilers}
\begin{frame}[fragile]{Exercise 9: Modules and Compilers}
\begin{itemize}
\item{Connect to the cluster using your training account: See excercise 1 if you have closed your terminal.}
\item{Go to the \alert{exercises} directory that you unzipped in hpcwork.}
\visible<1->{\begin{description}
\item{Try to compile the \alert{hello.c} program using the default \alert{gcc} compiler (it will fail because there is a deliberate bug).}
\end{description}}
\visible<2->{\begin{description}
\item[\emph{Hints:}]{\small \alert{gcc hello.c -o hello}}
\end{description}}
\item{To fix the problem, open the \alert{hello.c} file in the \alert{gedit} editor.}
\visible<3->{\begin{description}
\item[\emph{Hints:}]{\small Launch gedit in the background by doing \alert{gedit\&}. A gedit window should appear. Remove the word \alert{BUG}, save the file and recompile. Do \alert{./hello} to run the program.}
\end{description}}
\item{If you get this error: \begin{verbatim}WARNING **: cannot open display:\end{verbatim} then you have missed the '-Y' in your SSH command}
\end{itemize}
\end{frame}
 
\subsection{Excercise 9: Modules and Compilers}
\begin{frame}[fragile]{Exercise 9: Modules and Compilers}
\begin{itemize} 
\item{The default version of gcc is 4.8.5. Compile hello.c again with \alert{gcc 5.4.0}.}
\visible<1->{\begin{description}
\item[\emph{Hints:}]{\small module av, module load gcc-5.4.0-gcc-4.8.5-fis24gg, then \alert{gcc hello.c -o hello2}}
\end{description}}
\end{itemize}
\end{frame}

\subsection{Exercise 10: High Throughput Jobs}
\begin{frame}{Exercise 10: Submitting a Matlab job}
\begin{itemize}
\item{Submit a job which will run \alert{matlab} on the \alert{file.m} command file (which contains just the \alert{ver} command).}
\visible<2->{\begin{description}
\item[\emph{Hints:}]{\scriptsize\begin{enumerate}
\item{Load the matlab module using the \alert{job\_script} in your exercises directory.}
\item{Set the value of application to\hfill\break{}\alert{\"{}matlab -nodesktop -nosplash -nojvm\"{}}}
\item{Set the value of options to \alert{\"{}-r file\"{}}}
\item{Submit the job with \alert{sbatch job\_script}. The jobid is then printed.}
\item{Watch the job in the queue with \alert{squeue}.}
\item{After it has disappeared, open the output file \alert{slurm-jobid.out} in your editor. It should contain a list of licensed Matlab features.}
  \item{For more demanding work you can increase the available memory by increasing the number of cpus.}
  \end{enumerate}%
}
\end{description}}
\end{itemize}
\end{frame}

\subsection{Exercise 11: High Throughput Jobs}
\begin{frame}{Exercise 11: Submitting compiled code}
\begin{itemize}
\item{Submit a job which will run a copy of your hello program on 1 cpu.}
\visible<2->{\begin{description}
\item[\emph{Hints:}]{\scriptsize\begin{enumerate}
\item{Edit the script \alert{job\_script} in your exercises directory. Set:\hfill\\
\alert{\#SBATCH --nodes=1}\hfill\\
\alert{\#SBATCH --ntasks=1}\hfill\\
\alert{application="./hello"}}
\item{Submit the job with \alert{sbatch job\_script}. The jobid is then printed.}
\item{Watch the job in the queue with \alert{squeue}.}
\item{After it has disappeared, open the output file \alert{slurm-jobid.out} in your editor. There should be exactly one ``Hello, World!'' message.}
\end{enumerate}%
}
\end{description}}
\end{itemize}
\end{frame}

\section{Excercise 12: Array Jobs}
\begin{frame}{Exercise 11: Array Jobs}
\begin{itemize}
\item{Submit your last job in the form of an array with indices 1-32. Use -H with sbatch to mark the array as held (so that it won't run immediately).}
\visible<2->{\begin{description}
\item[\emph{Hints:}]{\scriptsize\begin{enumerate}
\item{Use \alert{sbatch -H -{}-array=1-32 job\_script}}
\item{Use \alert{squeue -u userid} to see your array job. Note that \alert{-r} reports each array element individually.}
\end{enumerate}%
}
\end{description}}
\item{Release array element 1 and allow it to run. Then release the others.}
\visible<3->{\begin{description}
\item[\emph{Hints:}]{\scriptsize\begin{enumerate}
\item{Use \alert{scontrol release \$\{{SLURM\_ARRAY\_JOB\_ID}\}\_{{\color{red}1}}}}
\item{Use \alert{squeue -u userid} again to watch what happens.}
\item{Release the others with\hfill\break
\null\qquad scontrol release \$\{{SLURM\_ARRAY\_JOB\_ID}\}\hfill\break
i.e. use the array id to release the entire array.}
  \item{When all the jobs complete you should have 64 slurm-\$\{SLURM\_ARRAY\_JOB\_ID\}\_N.out files saying hello from various cpus on possibly multiple nodes.}
\end{enumerate}%
}
\end{description}}
\end{itemize}
\end{frame}

\end{document}